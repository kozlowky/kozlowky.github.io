<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Карта</title>
    <script src="https://api-maps.yandex.ru/2.1/?apikey=98d71c59-85f2-4aa9-b291-db2b229ba3bc&lang=ru_RU" type="text/javascript"></script>
    <style>
        body {
            margin: 0;
            height: 100vh;
        }

        #map {
            width: 100%;
            height: 80%;
        }

        .map-controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 10;
            background: rgba(255, 255, 255, 0.7);
            padding: 10px;
            border-radius: 8px;
        }

        .map-controls input {
            margin-bottom: 10px;
            width: 100%;
        }

        .map-controls button {
            padding: 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="map-controls">
        <input id="from-city" class="form-control" placeholder="Город отправки" readonly />
        <input id="to-city" class="form-control" placeholder="Город доставки" readonly />
        <button id="done-button" disabled>Готово</button>
    </div>

    <script>
        let fromCity = null;
        let toCity = null;
        let fromMarker = null;
        let toMarker = null;

        ymaps.ready(init);

        function init() {
            const myMap = new ymaps.Map("map", {
                center: [55.76, 37.64], // Москва по умолчанию
                zoom: 5,
                controls: []
            });

            // Обработчик выбора города через поиск
            const searchControl = new ymaps.control.SearchControl({
                options: {
                    float: 'right',
                    provider: 'yandex#map',
                    size: 'large',
                    useMapBounds: true
                }
            });
            myMap.controls.add(searchControl);

            searchControl.events.add('resultselect', function (e) {
                const index = e.get('index');
                searchControl.getResult(index).then((res) => {
                    const coords = res.geometry.getCoordinates();
                    const name = res.properties.get('name');

                    // Если город отправки не выбран
                    if (!fromCity) {
                        fromCity = { coords, name };
                        document.getElementById('from-city').value = name;
                        if (fromMarker) myMap.geoObjects.remove(fromMarker);
                        fromMarker = new ymaps.Placemark(coords, { balloonContent: name });
                        myMap.geoObjects.add(fromMarker);
                    }
                    // Если город доставки не выбран
                    else if (!toCity) {
                        toCity = { coords, name };
                        document.getElementById('to-city').value = name;
                        if (toMarker) myMap.geoObjects.remove(toMarker);
                        toMarker = new ymaps.Placemark(coords, { balloonContent: name });
                        myMap.geoObjects.add(toMarker);
                    }

                    // Если оба города выбраны, активируем кнопку
                    if (fromCity && toCity) {
                        document.getElementById('done-button').disabled = false;
                    }
                });
            });

            // Обработчик клика по карте для выбора города
            myMap.events.add('click', function (e) {
                const coords = e.get('coords');
                const geoCoder = ymaps.geocode(coords);
                geoCoder.then(function (res) {
                    const firstGeoObject = res.geoObjects.get(0);
                    let name = 'Неизвестный город';
                    if (firstGeoObject) {
                        const locality = firstGeoObject.getLocalities();
                        const administrativeArea = firstGeoObject.getAdministrativeAreas();
                        name = locality.length ? locality.join(', ') : administrativeArea.join(', ');
                    }

                    // Если город отправки не выбран
                    if (!fromCity) {
                        fromCity = { coords, name };
                        document.getElementById('from-city').value = name;
                        if (fromMarker) myMap.geoObjects.remove(fromMarker);
                        fromMarker = new ymaps.Placemark(coords, { balloonContent: name });
                        myMap.geoObjects.add(fromMarker);
                    }
                    // Если город доставки не выбран
                    else if (!toCity) {
                        toCity = { coords, name };
                        document.getElementById('to-city').value = name;
                        if (toMarker) myMap.geoObjects.remove(toMarker);
                        toMarker = new ymaps.Placemark(coords, { balloonContent: name });
                        myMap.geoObjects.add(toMarker);
                    }

                    // Если оба города выбраны, активируем кнопку
                    if (fromCity && toCity) {
                        document.getElementById('done-button').disabled = false;
                    }
                });
            });

            // Кнопка "Готово"
            document.getElementById('done-button').addEventListener('click', function () {
                if (fromCity && toCity) {
                    localStorage.setItem('fromCity', fromCity.name);
                    localStorage.setItem('toCity', toCity.name);
                    window.location.href = 'index.html'; // Возвращаемся на главную страницу
                } else {
                    alert('Выберите оба города');
                }
            });
        }
    </script>
</body>
</html>
